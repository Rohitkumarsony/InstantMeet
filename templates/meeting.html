<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Meeting</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-md">
        <h2 class="text-2xl font-semibold text-center mb-4">Join Meeting</h2>
        <p class="text-gray-600 text-center hidden">Meeting Link: <span id="meetingLinkDisplay" class="font-medium text-blue-500"></span></p>
        
        <form id="joinMeetingForm" class="mt-6">
            <input type="text" id="userName" placeholder="Enter your name" required 
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <label class="flex items-center mt-4">
                <input type="checkbox" id="agreeCheck" required class="mr-2">
                I agree to join the meeting
            </label>
            <button type="submit" 
                class="w-full mt-4 bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all">
                Join Meeting
            </button>
        </form>
        <p id="status" class="text-red-500 text-center mt-4"></p>
    </div>

    <script>
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const meetingLink = urlParams.get('link');
            const meetingLinkDisplay = document.getElementById("meetingLinkDisplay");
            const statusElement = document.getElementById("status");

            if (!meetingLink) {
                statusElement.textContent = "Invalid meeting link.";
                return;
            }

            meetingLinkDisplay.textContent = meetingLink;

            document.getElementById("joinMeetingForm").addEventListener("submit", async function (event) {
                event.preventDefault();
                
                const userName = document.getElementById("userName").value.trim();
                const agreeCheck = document.getElementById("agreeCheck").checked;

                if (!userName || !agreeCheck) {
                    statusElement.textContent = "Please fill out all fields.";
                    return;
                }
                
                try {
                    const response = await fetch(`http://localhost:8000/user-validate-and-save-in-db?link=${encodeURIComponent(meetingLink)}&name=${encodeURIComponent(userName)}`, {
                        method: "POST"
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === "success") {
                        window.location.href = `/grouped_meeting?username=${encodeURIComponent(userName)}&link=${encodeURIComponent(meetingLink)}`;

                    } else {
                        statusElement.textContent = data.message || "Error joining the meeting.";
                    }
                } catch (error) {
                    statusElement.textContent = "Connection error. Please try again.";
                }
            });
        };
    </script>
</body>
</html>
